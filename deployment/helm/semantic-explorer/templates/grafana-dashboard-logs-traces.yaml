{{- if and .Values.grafana.enabled (not .Values.grafana.external.enabled) }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "semantic-explorer.fullname" . }}-dashboard-logs-traces
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "semantic-explorer.labels" . | nindent 4 }}
    grafana_dashboard: "1"
  annotations:
    grafana_folder: "Semantic Explorer"
data:
  logs-traces.json: |-
    {
      "annotations": {
        "list": [
          {
            "builtIn": 1,
            "datasource": "-- Grafana --",
            "enable": true,
            "hide": true,
            "iconColor": "rgba(0, 211, 255, 1)",
            "name": "Annotations & Alerts",
            "type": "dashboard"
          }
        ]
      },
      "editable": true,
      "gnetId": null,
      "graphTooltip": 1,
      "id": null,
      "links": [],
      "templating": {
        "list": [
          {
            "current": { "selected": false, "text": "All", "value": "$__all" },
            "hide": 0,
            "includeAll": true,
            "label": "Service",
            "multi": true,
            "name": "service",
            "options": [
              { "selected": true, "text": "All", "value": "$__all" },
              { "selected": false, "text": "semantic-explorer", "value": "semantic-explorer" },
              { "selected": false, "text": "embedding-inference-api", "value": "embedding-inference-api" },
              { "selected": false, "text": "llm-inference-api", "value": "llm-inference-api" },
              { "selected": false, "text": "worker-collections", "value": "worker-collections" },
              { "selected": false, "text": "worker-datasets", "value": "worker-datasets" },
              { "selected": false, "text": "worker-visualizations-py", "value": "worker-visualizations-py" }
            ],
            "query": "semantic-explorer,embedding-inference-api,llm-inference-api,worker-collections,worker-datasets,worker-visualizations-py",
            "skipUrlSync": false,
            "type": "custom"
          },
          {
            "current": { "selected": false, "text": "All", "value": "$__all" },
            "hide": 0,
            "includeAll": true,
            "label": "Severity",
            "multi": true,
            "name": "severity",
            "options": [
              { "selected": true, "text": "All", "value": "$__all" },
              { "selected": false, "text": "ERROR", "value": "ERROR" },
              { "selected": false, "text": "WARN", "value": "WARN" },
              { "selected": false, "text": "INFO", "value": "INFO" },
              { "selected": false, "text": "DEBUG", "value": "DEBUG" },
              { "selected": false, "text": "TRACE", "value": "TRACE" }
            ],
            "query": "ERROR,WARN,INFO,DEBUG,TRACE",
            "skipUrlSync": false,
            "type": "custom"
          },
          {
            "current": { "selected": false, "text": "", "value": "" },
            "hide": 0,
            "label": "Search Text",
            "name": "search_text",
            "options": [],
            "query": "",
            "skipUrlSync": false,
            "type": "textbox"
          }
        ]
      },
      "panels": [
        {
          "collapsed": false,
          "gridPos": { "h": 1, "w": 24, "x": 0, "y": 0 },
          "id": 50,
          "panels": [],
          "title": "üîç Searchable Logs & Traces",
          "type": "row"
        },
        {
          "datasource": { "type": "quickwit-quickwit-datasource", "uid": "quickwit" },
          "description": "Searchable and filterable logs from Quickwit. Query syntax: service_name:semantic-explorer AND severity_text:ERROR",
          "fieldConfig": {
            "defaults": {
              "custom": { "align": "left", "cellOptions": { "type": "auto" }, "filterable": true }
            },
            "overrides": [
              {
                "matcher": { "id": "byName", "options": "severity_text" },
                "properties": [
                  { "id": "custom.cellOptions", "value": { "type": "color-background" } },
                  { "id": "mappings", "value": [
                    { "options": { "ERROR": { "color": "red", "index": 0 } }, "type": "value" },
                    { "options": { "WARN": { "color": "orange", "index": 1 } }, "type": "value" },
                    { "options": { "INFO": { "color": "green", "index": 2 } }, "type": "value" },
                    { "options": { "DEBUG": { "color": "blue", "index": 3 } }, "type": "value" }
                  ] }
                ]
              },
              { "matcher": { "id": "byName", "options": "body.message" }, "properties": [{ "id": "custom.width", "value": 600 }] }
            ]
          },
          "gridPos": { "h": 20, "w": 24, "x": 0, "y": 1 },
          "id": 51,
          "options": { "cellHeight": "sm", "showHeader": true, "footer": { "enablePagination": true, "show": false } },
          "pluginVersion": "10.0.0",
          "targets": [
            { "datasource": { "type": "quickwit-quickwit-datasource", "uid": "quickwit" }, "metrics": [{ "type": "logs", "id": "1" }], "query": "*", "refId": "A" }
          ],
          "title": "üìã Searchable Logs Explorer",
          "transformations": [
            {
              "id": "organize",
              "options": {
                "excludeByName": { "observed_timestamp_nanos": true, "severity_number": true, "trace_flags": true },
                "indexByName": { "timestamp_nanos": 0, "service_name": 1, "severity_text": 2, "body.message": 3, "scope_name": 4, "trace_id": 5 },
                "renameByName": { "body.message": "Message", "scope_name": "Scope", "service_name": "Service", "severity_text": "Level", "timestamp_nanos": "Timestamp", "trace_id": "Trace ID" }
              }
            }
          ],
          "type": "table"
        },
        {
          "datasource": { "type": "quickwit-quickwit-datasource", "uid": "quickwit-traces-data" },
          "description": "Searchable traces from Quickwit. Query spans and trace data. Query syntax: service_name:semantic-explorer",
          "fieldConfig": {
            "defaults": { "custom": { "align": "left", "cellOptions": { "type": "auto" }, "filterable": true } },
            "overrides": [
              {
                "matcher": { "id": "byName", "options": "span_duration_millis" },
                "properties": [
                  { "id": "custom.cellOptions", "value": { "mode": "gradient", "type": "gauge" } },
                  { "id": "color", "value": { "mode": "continuous-YlRd" } },
                  { "id": "unit", "value": "ms" }
                ]
              }
            ]
          },
          "gridPos": { "h": 20, "w": 24, "x": 0, "y": 21 },
          "id": 52,
          "options": { "cellHeight": "sm", "showHeader": true, "footer": { "enablePagination": true, "show": false } },
          "pluginVersion": "10.0.0",
          "targets": [
            { "datasource": { "type": "quickwit-quickwit-datasource", "uid": "quickwit-traces-data" }, "metrics": [{ "type": "logs", "id": "1" }], "query": "*", "refId": "A" }
          ],
          "title": "üîé Searchable Traces Explorer",
          "transformations": [
            {
              "id": "organize",
              "options": {
                "excludeByName": { "span_fingerprint": true, "resource_attributes": true },
                "indexByName": { "span_start_timestamp_nanos": 0, "service_name": 1, "span_name": 2, "span_kind": 3, "span_duration_millis": 4, "trace_id": 5, "span_id": 6 },
                "renameByName": { "service_name": "Service", "span_duration_millis": "Duration (ms)", "span_id": "Span ID", "span_kind": "Kind", "span_name": "Operation", "span_start_timestamp_nanos": "Timestamp", "trace_id": "Trace ID" }
              }
            }
          ],
          "type": "table"
        },
        {
          "collapsed": true,
          "gridPos": { "h": 1, "w": 24, "x": 0, "y": 41 },
          "id": 1,
          "panels": [
            {
              "datasource": { "type": "prometheus", "uid": "prometheus" },
              "fieldConfig": {
                "defaults": { "color": { "mode": "thresholds" }, "mappings": [], "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }, { "color": "yellow", "value": 1000 }, { "color": "red", "value": 5000 }] }, "unit": "short" }
              },
              "gridPos": { "h": 6, "w": 4, "x": 0, "y": 42 },
              "id": 2,
              "options": { "colorMode": "value", "graphMode": "area", "justifyMode": "auto", "orientation": "auto", "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false }, "textMode": "auto" },
              "pluginVersion": "10.0.0",
              "targets": [{ "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "sum(increase(api_http_requests_total{namespace=\"{{ .Release.Namespace }}\"}[1h]))", "refId": "A" }],
              "title": "Total Requests (1h)",
              "type": "stat"
            },
            {
              "datasource": { "type": "prometheus", "uid": "prometheus" },
              "fieldConfig": {
                "defaults": { "color": { "mode": "thresholds" }, "mappings": [], "thresholds": { "mode": "absolute", "steps": [{ "color": "red", "value": null }, { "color": "yellow", "value": 1 }, { "color": "green", "value": 10 }] }, "unit": "short" }
              },
              "gridPos": { "h": 6, "w": 4, "x": 4, "y": 42 },
              "id": 3,
              "options": { "colorMode": "value", "graphMode": "area", "justifyMode": "auto", "orientation": "auto", "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false }, "textMode": "auto" },
              "pluginVersion": "10.0.0",
              "targets": [{ "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "sum(up{namespace=\"{{ .Release.Namespace }}\", job=~\".*api.*|.*worker.*\"})", "refId": "A" }],
              "title": "App Services Up",
              "type": "stat"
            },
            {
              "datasource": { "type": "prometheus", "uid": "prometheus" },
              "fieldConfig": {
                "defaults": { "color": { "mode": "thresholds" }, "mappings": [], "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }, { "color": "yellow", "value": 0.5 }, { "color": "red", "value": 1 }] }, "unit": "s" }
              },
              "gridPos": { "h": 6, "w": 4, "x": 8, "y": 42 },
              "id": 4,
              "options": { "colorMode": "value", "graphMode": "area", "justifyMode": "auto", "orientation": "auto", "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false }, "textMode": "auto" },
              "pluginVersion": "10.0.0",
              "targets": [{ "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "histogram_quantile(0.95, sum(rate(api_http_requests_duration_seconds_bucket{namespace=\"{{ .Release.Namespace }}\"}[5m])) by (le)) or vector(0)", "refId": "A" }],
              "title": "P95 Latency",
              "type": "stat"
            },
            {
              "datasource": { "type": "prometheus", "uid": "prometheus" },
              "fieldConfig": {
                "defaults": { "color": { "mode": "thresholds" }, "mappings": [], "max": 100, "min": 0, "thresholds": { "mode": "absolute", "steps": [{ "color": "red", "value": null }, { "color": "yellow", "value": 95 }, { "color": "green", "value": 99 }] }, "unit": "percent" }
              },
              "gridPos": { "h": 6, "w": 4, "x": 12, "y": 42 },
              "id": 5,
              "options": { "colorMode": "value", "graphMode": "area", "justifyMode": "auto", "orientation": "auto", "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false }, "textMode": "auto" },
              "pluginVersion": "10.0.0",
              "targets": [{ "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "sum(rate(api_http_requests_total{namespace=\"{{ .Release.Namespace }}\", status=~\"2..\"}[5m])) / sum(rate(api_http_requests_total{namespace=\"{{ .Release.Namespace }}\"}[5m])) * 100", "refId": "A" }],
              "title": "Success Rate",
              "type": "stat"
            },
            {
              "datasource": { "type": "prometheus", "uid": "prometheus" },
              "fieldConfig": {
                "defaults": { "color": { "mode": "thresholds" }, "mappings": [], "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }, { "color": "yellow", "value": 10 }, { "color": "red", "value": 50 }] }, "unit": "short" }
              },
              "gridPos": { "h": 6, "w": 4, "x": 16, "y": 42 },
              "id": 6,
              "options": { "colorMode": "value", "graphMode": "area", "justifyMode": "auto", "orientation": "auto", "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false }, "textMode": "auto" },
              "pluginVersion": "10.0.0",
              "targets": [{ "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "sum(increase(api_http_requests_total{namespace=\"{{ .Release.Namespace }}\", status=~\"5..\"}[1h]))", "refId": "A" }],
              "title": "Errors (1h)",
              "type": "stat"
            },
            {
              "datasource": { "type": "prometheus", "uid": "prometheus" },
              "fieldConfig": {
                "defaults": { "color": { "mode": "thresholds" }, "mappings": [], "thresholds": { "mode": "absolute", "steps": [{ "color": "blue", "value": null }] }, "unit": "reqps" }
              },
              "gridPos": { "h": 6, "w": 4, "x": 20, "y": 42 },
              "id": 7,
              "options": { "colorMode": "value", "graphMode": "area", "justifyMode": "auto", "orientation": "auto", "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false }, "textMode": "auto" },
              "pluginVersion": "10.0.0",
              "targets": [{ "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "sum(rate(api_http_requests_total{namespace=\"{{ .Release.Namespace }}\"}[5m]))", "refId": "A" }],
              "title": "Request Rate",
              "type": "stat"
            }
          ],
          "title": "System Overview",
          "type": "row"
        },
        {
          "collapsed": true,
          "gridPos": { "h": 1, "w": 24, "x": 0, "y": 48 },
          "id": 10,
          "panels": [
            {
              "datasource": { "type": "prometheus", "uid": "prometheus" },
              "fieldConfig": {
                "defaults": {
                  "color": { "mode": "palette-classic" },
                  "custom": { "axisCenteredZero": false, "axisLabel": "Spans/sec", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 20, "gradientMode": "opacity", "hideFrom": { "legend": false, "tooltip": false, "viz": false }, "lineInterpolation": "smooth", "lineWidth": 2, "pointSize": 5, "scaleDistribution": { "type": "linear" }, "showPoints": "never", "spanNulls": false, "stacking": { "group": "A", "mode": "none" }, "thresholdsStyle": { "mode": "off" } },
                  "mappings": [],
                  "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }] },
                  "unit": "short"
                }
              },
              "gridPos": { "h": 12, "w": 12, "x": 0, "y": 49 },
              "id": 11,
              "options": { "legend": { "calcs": ["mean", "last"], "displayMode": "table", "placement": "bottom", "showLegend": true }, "tooltip": { "mode": "multi", "sort": "desc" } },
              "targets": [
                { "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "rate(quickwit_otlp_ingested_spans_total{namespace=\"{{ .Release.Namespace }}\"}[5m])", "legendFormat": "Ingested Spans", "refId": "A" },
                { "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "sum by (receiver) (rate(otelcol_receiver_accepted_spans_total{namespace=\"{{ .Release.Namespace }}\"}[5m]))", "legendFormat": "{{ `{{receiver}}` }} Received", "refId": "B" }
              ],
              "title": "Trace Ingestion Rate",
              "type": "timeseries"
            },
            {
              "datasource": { "type": "prometheus", "uid": "prometheus" },
              "fieldConfig": {
                "defaults": { "color": { "mode": "thresholds" }, "mappings": [], "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }, { "color": "yellow", "value": 1000 }, { "color": "red", "value": 5000 }] }, "unit": "short" }
              },
              "gridPos": { "h": 6, "w": 6, "x": 12, "y": 49 },
              "id": 111,
              "options": { "colorMode": "value", "graphMode": "area", "justifyMode": "auto", "orientation": "auto", "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false }, "textMode": "auto" },
              "pluginVersion": "10.0.0",
              "targets": [{ "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "sum(increase(quickwit_otlp_ingested_spans_total{namespace=\"{{ .Release.Namespace }}\"}[1h]))", "refId": "A" }],
              "title": "Spans Ingested (1h)",
              "type": "stat"
            },
            {
              "datasource": { "type": "prometheus", "uid": "prometheus" },
              "fieldConfig": {
                "defaults": { "color": { "mode": "thresholds" }, "mappings": [], "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }, { "color": "yellow", "value": 1 }, { "color": "red", "value": 10 }] }, "unit": "short" }
              },
              "gridPos": { "h": 6, "w": 6, "x": 18, "y": 49 },
              "id": 112,
              "options": { "colorMode": "value", "graphMode": "area", "justifyMode": "auto", "orientation": "auto", "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false }, "textMode": "auto" },
              "pluginVersion": "10.0.0",
              "targets": [{ "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "sum(increase(otelcol_receiver_refused_spans_total{namespace=\"{{ .Release.Namespace }}\"}[1h]))", "refId": "A" }],
              "title": "Spans Refused (1h)",
              "type": "stat"
            },
            {
              "datasource": { "type": "prometheus", "uid": "prometheus" },
              "fieldConfig": {
                "defaults": {
                  "color": { "mode": "palette-classic" },
                  "custom": { "axisCenteredZero": false, "axisLabel": "Duration", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 20, "gradientMode": "opacity", "hideFrom": { "legend": false, "tooltip": false, "viz": false }, "lineInterpolation": "smooth", "lineWidth": 2, "pointSize": 5, "scaleDistribution": { "type": "linear" }, "showPoints": "never", "spanNulls": false, "stacking": { "group": "A", "mode": "none" }, "thresholdsStyle": { "mode": "off" } },
                  "mappings": [],
                  "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }] },
                  "unit": "s"
                }
              },
              "gridPos": { "h": 12, "w": 12, "x": 0, "y": 55 },
              "id": 12,
              "options": { "legend": { "calcs": ["mean", "max", "min"], "displayMode": "table", "placement": "bottom", "showLegend": true }, "tooltip": { "mode": "multi", "sort": "desc" } },
              "targets": [
                { "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "histogram_quantile(0.50, sum(rate(api_http_requests_duration_seconds_bucket{namespace=\"{{ .Release.Namespace }}\"}[$__rate_interval])) by (le, endpoint))", "legendFormat": "{{ `{{endpoint}}` }} p50", "refId": "A" },
                { "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "histogram_quantile(0.95, sum(rate(api_http_requests_duration_seconds_bucket{namespace=\"{{ .Release.Namespace }}\"}[$__rate_interval])) by (le, endpoint))", "legendFormat": "{{ `{{endpoint}}` }} p95", "refId": "B" },
                { "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "histogram_quantile(0.99, sum(rate(api_http_requests_duration_seconds_bucket{namespace=\"{{ .Release.Namespace }}\"}[$__rate_interval])) by (le, endpoint))", "legendFormat": "{{ `{{endpoint}}` }} p99", "refId": "C" }
              ],
              "title": "Request Latency Distribution (by Endpoint)",
              "type": "timeseries"
            },
            {
              "datasource": { "type": "prometheus", "uid": "prometheus" },
              "fieldConfig": {
                "defaults": {
                  "color": { "mode": "palette-classic" },
                  "custom": { "axisCenteredZero": false, "axisLabel": "Requests/sec", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 20, "gradientMode": "opacity", "hideFrom": { "legend": false, "tooltip": false, "viz": false }, "lineInterpolation": "smooth", "lineWidth": 2, "pointSize": 5, "scaleDistribution": { "type": "linear" }, "showPoints": "never", "spanNulls": false, "stacking": { "group": "A", "mode": "none" }, "thresholdsStyle": { "mode": "off" } },
                  "mappings": [],
                  "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }] },
                  "unit": "reqps"
                },
                "overrides": [
                  { "matcher": { "id": "byRegexp", "options": ".*5[0-9]{2}.*" }, "properties": [{ "id": "color", "value": { "fixedColor": "red", "mode": "fixed" } }] },
                  { "matcher": { "id": "byRegexp", "options": ".*4[0-9]{2}.*" }, "properties": [{ "id": "color", "value": { "fixedColor": "yellow", "mode": "fixed" } }] },
                  { "matcher": { "id": "byRegexp", "options": ".*2[0-9]{2}.*" }, "properties": [{ "id": "color", "value": { "fixedColor": "green", "mode": "fixed" } }] }
                ]
              },
              "gridPos": { "h": 12, "w": 12, "x": 12, "y": 55 },
              "id": 13,
              "options": { "legend": { "calcs": ["mean", "sum"], "displayMode": "table", "placement": "bottom", "showLegend": true }, "tooltip": { "mode": "multi", "sort": "desc" } },
              "targets": [{ "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "sum by (status) (rate(api_http_requests_total{namespace=\"{{ .Release.Namespace }}\"}[$__rate_interval]))", "legendFormat": "{{ `{{status}}` }}", "refId": "A" }],
              "title": "Request Rate by Status Code",
              "type": "timeseries"
            },
            {
              "datasource": { "type": "prometheus", "uid": "prometheus" },
              "fieldConfig": {
                "defaults": {
                  "color": { "mode": "palette-classic" },
                  "custom": { "axisCenteredZero": false, "axisLabel": "Requests/sec", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "bars", "fillOpacity": 80, "gradientMode": "none", "hideFrom": { "legend": false, "tooltip": false, "viz": false }, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5, "scaleDistribution": { "type": "linear" }, "showPoints": "never", "spanNulls": false, "stacking": { "group": "A", "mode": "normal" }, "thresholdsStyle": { "mode": "off" } },
                  "mappings": [],
                  "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }] },
                  "unit": "reqps"
                }
              },
              "gridPos": { "h": 12, "w": 24, "x": 0, "y": 67 },
              "id": 14,
              "options": { "legend": { "calcs": ["mean", "max", "sum"], "displayMode": "table", "placement": "bottom", "showLegend": true }, "tooltip": { "mode": "multi", "sort": "desc" } },
              "targets": [{ "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "sum by (endpoint) (rate(api_http_requests_total{namespace=\"{{ .Release.Namespace }}\", endpoint!~\".*health.*|.*metrics.*\"}[$__rate_interval]))", "legendFormat": "{{ `{{endpoint}}` }}", "refId": "A" }],
              "title": "Traffic by Endpoint",
              "type": "timeseries"
            }
          ],
          "title": "Trace Analysis",
          "type": "row"
        },
        {
          "collapsed": true,
          "gridPos": { "h": 1, "w": 24, "x": 0, "y": 89 },
          "id": 20,
          "panels": [
            {
              "datasource": { "type": "prometheus", "uid": "prometheus" },
              "description": "Log ingestion rate from OTEL Collector to Quickwit",
              "fieldConfig": {
                "defaults": {
                  "color": { "mode": "palette-classic" },
                  "custom": { "axisCenteredZero": false, "axisLabel": "Logs/min", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 20, "gradientMode": "opacity", "hideFrom": { "legend": false, "tooltip": false, "viz": false }, "lineInterpolation": "smooth", "lineWidth": 2, "pointSize": 5, "scaleDistribution": { "type": "linear" }, "showPoints": "never", "spanNulls": false, "stacking": { "group": "A", "mode": "normal" }, "thresholdsStyle": { "mode": "off" } },
                  "mappings": [],
                  "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }] },
                  "unit": "short"
                },
                "overrides": [
                  { "matcher": { "id": "byRegexp", "options": ".*ERROR.*" }, "properties": [{ "id": "color", "value": { "fixedColor": "red", "mode": "fixed" } }] },
                  { "matcher": { "id": "byRegexp", "options": ".*WARN.*" }, "properties": [{ "id": "color", "value": { "fixedColor": "orange", "mode": "fixed" } }] },
                  { "matcher": { "id": "byRegexp", "options": ".*INFO.*" }, "properties": [{ "id": "color", "value": { "fixedColor": "green", "mode": "fixed" } }] }
                ]
              },
              "gridPos": { "h": 18, "w": 24, "x": 0, "y": 90 },
              "id": 21,
              "options": { "legend": { "calcs": ["sum", "last"], "displayMode": "table", "placement": "right", "showLegend": true, "width": 300 }, "tooltip": { "mode": "multi", "sort": "desc" } },
              "targets": [{ "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "sum by (service_name, severity_text) (rate(quickwit_otlp_ingested_log_records_total{namespace=\"{{ .Release.Namespace }}\"}[1m]))", "legendFormat": "{{ `{{service_name}}` }} - {{ `{{severity_text}}` }}", "refId": "A" }],
              "title": "Log Ingestion Rate by Service & Severity",
              "type": "timeseries"
            },
            {
              "datasource": { "type": "prometheus", "uid": "prometheus" },
              "fieldConfig": {
                "defaults": {
                  "color": { "mode": "thresholds" },
                  "custom": { "align": "left", "cellOptions": { "type": "auto" }, "inspect": false },
                  "mappings": [],
                  "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }] }
                },
                "overrides": [{ "matcher": { "id": "byName", "options": "Count" }, "properties": [{ "id": "custom.cellOptions", "value": { "mode": "gradient", "type": "gauge" } }, { "id": "color", "value": { "mode": "continuous-GrYlRd" } }] }]
              },
              "gridPos": { "h": 12, "w": 12, "x": 0, "y": 108 },
              "id": 22,
              "options": { "cellHeight": "sm", "footer": { "countRows": false, "enablePagination": true, "fields": "", "reducer": ["sum"], "show": false }, "frameIndex": 0, "showHeader": true, "sortBy": [{ "desc": true, "displayName": "Count" }] },
              "pluginVersion": "10.0.0",
              "targets": [{ "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "topk(25, sum by (endpoint, method) (increase(api_http_requests_total{namespace=\"{{ .Release.Namespace }}\"}[$__range])))", "format": "table", "instant": true, "legendFormat": "__auto", "refId": "A" }],
              "title": "üîù Most Frequent API Calls",
              "transformations": [{ "id": "organize", "options": { "excludeByName": { "Time": true }, "indexByName": {}, "renameByName": { "Value": "Count", "endpoint": "Endpoint", "method": "Method" } } }],
              "type": "table"
            },
            {
              "datasource": { "type": "prometheus", "uid": "prometheus" },
              "fieldConfig": {
                "defaults": {
                  "color": { "mode": "thresholds" },
                  "custom": { "align": "left", "cellOptions": { "type": "auto" }, "inspect": false },
                  "mappings": [],
                  "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }] }
                },
                "overrides": [{ "matcher": { "id": "byName", "options": "Duration (s)" }, "properties": [{ "id": "custom.cellOptions", "value": { "mode": "gradient", "type": "gauge" } }, { "id": "color", "value": { "mode": "continuous-YlRd" } }, { "id": "unit", "value": "s" }] }]
              },
              "gridPos": { "h": 12, "w": 12, "x": 12, "y": 108 },
              "id": 23,
              "options": { "cellHeight": "sm", "footer": { "countRows": false, "enablePagination": true, "fields": "", "reducer": ["sum"], "show": false }, "frameIndex": 0, "showHeader": true, "sortBy": [{ "desc": true, "displayName": "Duration (s)" }] },
              "pluginVersion": "10.0.0",
              "targets": [{ "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "topk(25, histogram_quantile(0.95, sum by (le, endpoint) (rate(api_http_requests_duration_seconds_bucket{namespace=\"{{ .Release.Namespace }}\", endpoint!~\".*health.*|.*metrics.*\"}[5m]))) > 0)", "format": "table", "instant": true, "legendFormat": "__auto", "refId": "A" }],
              "title": "üêå Slowest Endpoints (P95)",
              "transformations": [{ "id": "organize", "options": { "excludeByName": { "Time": true }, "indexByName": {}, "renameByName": { "Value": "Duration (s)", "endpoint": "Endpoint" } } }],
              "type": "table"
            }
          ],
          "title": "Logs & Messages",
          "type": "row"
        },
        {
          "collapsed": true,
          "gridPos": { "h": 1, "w": 24, "x": 0, "y": 120 },
          "id": 30,
          "panels": [
            {
              "datasource": { "type": "prometheus", "uid": "prometheus" },
              "fieldConfig": {
                "defaults": {
                  "color": { "mode": "palette-classic" },
                  "custom": { "axisCenteredZero": false, "axisLabel": "Errors/sec", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 30, "gradientMode": "opacity", "hideFrom": { "legend": false, "tooltip": false, "viz": false }, "lineInterpolation": "smooth", "lineWidth": 2, "pointSize": 5, "scaleDistribution": { "type": "linear" }, "showPoints": "never", "spanNulls": false, "stacking": { "group": "A", "mode": "normal" }, "thresholdsStyle": { "mode": "off" } },
                  "mappings": [],
                  "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }] },
                  "unit": "reqps"
                },
                "overrides": [
                  { "matcher": { "id": "byRegexp", "options": ".*5[0-9]{2}.*" }, "properties": [{ "id": "color", "value": { "fixedColor": "dark-red", "mode": "fixed" } }] },
                  { "matcher": { "id": "byRegexp", "options": ".*4[0-9]{2}.*" }, "properties": [{ "id": "color", "value": { "fixedColor": "dark-orange", "mode": "fixed" } }] }
                ]
              },
              "gridPos": { "h": 12, "w": 12, "x": 0, "y": 121 },
              "id": 31,
              "options": { "legend": { "calcs": ["sum", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true }, "tooltip": { "mode": "multi", "sort": "desc" } },
              "targets": [{ "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "sum by (status) (rate(api_http_requests_total{namespace=\"{{ .Release.Namespace }}\", status=~\"4..|5..\"}[$__rate_interval]))", "legendFormat": "{{ `{{status}}` }}", "refId": "A" }],
              "title": "Error Rate Over Time",
              "type": "timeseries"
            },
            {
              "datasource": { "type": "prometheus", "uid": "prometheus" },
              "fieldConfig": {
                "defaults": {
                  "color": { "mode": "thresholds" },
                  "custom": { "align": "left", "cellOptions": { "type": "auto" }, "inspect": false },
                  "mappings": [],
                  "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }] }
                },
                "overrides": [{ "matcher": { "id": "byName", "options": "Count" }, "properties": [{ "id": "custom.cellOptions", "value": { "mode": "gradient", "type": "gauge" } }, { "id": "color", "value": { "mode": "continuous-GrYlRd" } }] }]
              },
              "gridPos": { "h": 12, "w": 12, "x": 12, "y": 121 },
              "id": 32,
              "options": { "cellHeight": "sm", "footer": { "countRows": false, "enablePagination": true, "fields": "", "reducer": ["sum"], "show": false }, "frameIndex": 0, "showHeader": true, "sortBy": [{ "desc": true, "displayName": "Count" }] },
              "pluginVersion": "10.0.0",
              "targets": [{ "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "topk(20, sum by (endpoint, status) (increase(api_http_requests_total{namespace=\"{{ .Release.Namespace }}\", status=~\"4..|5..\"}[$__range])))", "format": "table", "instant": true, "legendFormat": "__auto", "refId": "A" }],
              "title": "Top Failing Endpoints",
              "transformations": [{ "id": "organize", "options": { "excludeByName": { "Time": true }, "indexByName": {}, "renameByName": { "Value": "Count", "endpoint": "Endpoint", "status": "Status" } } }],
              "type": "table"
            }
          ],
          "title": "Errors & Issues",
          "type": "row"
        },
        {
          "collapsed": true,
          "gridPos": { "h": 1, "w": 24, "x": 0, "y": 133 },
          "id": 40,
          "panels": [
            {
              "datasource": { "type": "prometheus", "uid": "prometheus" },
              "fieldConfig": {
                "defaults": {
                  "color": { "mode": "palette-classic" },
                  "custom": { "axisCenteredZero": false, "axisLabel": "Duration", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": { "legend": false, "tooltip": false, "viz": false }, "lineInterpolation": "smooth", "lineWidth": 2, "pointSize": 5, "scaleDistribution": { "type": "linear" }, "showPoints": "never", "spanNulls": false, "stacking": { "group": "A", "mode": "none" }, "thresholdsStyle": { "mode": "off" } },
                  "mappings": [],
                  "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }] },
                  "unit": "s"
                }
              },
              "gridPos": { "h": 12, "w": 24, "x": 0, "y": 134 },
              "id": 41,
              "options": { "legend": { "calcs": ["mean", "max"], "displayMode": "table", "placement": "right", "showLegend": true }, "tooltip": { "mode": "multi", "sort": "desc" } },
              "targets": [
                { "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "histogram_quantile(0.50, sum(rate(api_http_requests_duration_seconds_bucket{namespace=\"{{ .Release.Namespace }}\", endpoint!~\".*health.*|.*metrics.*\"}[$__rate_interval])) by (le, endpoint))", "legendFormat": "{{ `{{endpoint}}` }} p50", "refId": "A" },
                { "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "histogram_quantile(0.95, sum(rate(api_http_requests_duration_seconds_bucket{namespace=\"{{ .Release.Namespace }}\", endpoint!~\".*health.*|.*metrics.*\"}[$__rate_interval])) by (le, endpoint))", "legendFormat": "{{ `{{endpoint}}` }} p95", "refId": "B" },
                { "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "histogram_quantile(0.99, sum(rate(api_http_requests_duration_seconds_bucket{namespace=\"{{ .Release.Namespace }}\", endpoint!~\".*health.*|.*metrics.*\"}[$__rate_interval])) by (le, endpoint))", "legendFormat": "{{ `{{endpoint}}` }} p99", "refId": "C" }
              ],
              "title": "Detailed Latency Percentiles (p50, p95, p99)",
              "type": "timeseries"
            },
            {
              "datasource": { "type": "prometheus", "uid": "prometheus" },
              "fieldConfig": {
                "defaults": {
                  "color": { "mode": "palette-classic" },
                  "custom": { "axisCenteredZero": false, "axisLabel": "Requests", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "bars", "fillOpacity": 80, "gradientMode": "none", "hideFrom": { "legend": false, "tooltip": false, "viz": false }, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5, "scaleDistribution": { "type": "linear" }, "showPoints": "never", "spanNulls": false, "stacking": { "group": "A", "mode": "normal" }, "thresholdsStyle": { "mode": "off" } },
                  "mappings": [],
                  "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }] },
                  "unit": "reqps"
                }
              },
              "gridPos": { "h": 12, "w": 12, "x": 0, "y": 146 },
              "id": 42,
              "options": { "legend": { "calcs": ["sum"], "displayMode": "table", "placement": "bottom", "showLegend": true }, "tooltip": { "mode": "multi", "sort": "desc" } },
              "targets": [{ "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "sum by (method) (rate(api_http_requests_total{namespace=\"{{ .Release.Namespace }}\"}[$__rate_interval]))", "legendFormat": "{{ `{{method}}` }}", "refId": "A" }],
              "title": "Traffic by HTTP Method",
              "type": "timeseries"
            },
            {
              "datasource": { "type": "prometheus", "uid": "prometheus" },
              "fieldConfig": {
                "defaults": {
                  "color": { "mode": "thresholds" },
                  "custom": { "align": "left", "cellOptions": { "type": "auto" }, "inspect": false },
                  "mappings": [],
                  "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }, { "color": "yellow", "value": 0.1 }, { "color": "red", "value": 0.5 }] }
                },
                "overrides": [
                  { "matcher": { "id": "byName", "options": "Avg Duration (s)" }, "properties": [{ "id": "custom.cellOptions", "value": { "mode": "gradient", "type": "gauge" } }, { "id": "unit", "value": "s" }] },
                  { "matcher": { "id": "byName", "options": "Total Calls" }, "properties": [{ "id": "custom.cellOptions", "value": { "mode": "gradient", "type": "gauge" } }, { "id": "color", "value": { "mode": "continuous-BlYlRd" } }] }
                ]
              },
              "gridPos": { "h": 12, "w": 12, "x": 12, "y": 146 },
              "id": 43,
              "options": { "cellHeight": "sm", "footer": { "countRows": false, "enablePagination": true, "fields": "", "reducer": ["sum"], "show": false }, "frameIndex": 0, "showHeader": true, "sortBy": [{ "desc": true, "displayName": "Avg Duration (s)" }] },
              "pluginVersion": "10.0.0",
              "targets": [
                { "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "sum by (endpoint) (increase(api_http_requests_duration_seconds_sum{namespace=\"{{ .Release.Namespace }}\", endpoint!~\".*health.*|.*metrics.*\"}[$__range])) / sum by (endpoint) (increase(api_http_requests_duration_seconds_count{namespace=\"{{ .Release.Namespace }}\", endpoint!~\".*health.*|.*metrics.*\"}[$__range]))", "format": "table", "instant": true, "legendFormat": "__auto", "refId": "A" },
                { "datasource": { "type": "prometheus", "uid": "prometheus" }, "expr": "sum by (endpoint) (increase(api_http_requests_total{namespace=\"{{ .Release.Namespace }}\", endpoint!~\".*health.*|.*metrics.*\"}[$__range]))", "format": "table", "instant": true, "legendFormat": "__auto", "refId": "B" }
              ],
              "title": "‚è±Ô∏è Endpoint Performance Summary",
              "transformations": [
                { "id": "merge", "options": {} },
                { "id": "organize", "options": { "excludeByName": { "Time": true }, "indexByName": {}, "renameByName": { "Value #A": "Avg Duration (s)", "Value #B": "Total Calls", "endpoint": "Endpoint" } } }
              ],
              "type": "table"
            }
          ],
          "title": "Deep Trace Analysis",
          "type": "row"
        }
      ],
      "refresh": "30s",
      "schemaVersion": 39,
      "style": "dark",
      "tags": ["semantic-explorer", "logs", "traces", "observability"],
      "time": { "from": "now-1h", "to": "now" },
      "timepicker": {},
      "timezone": "",
      "title": "Logs & Traces",
      "uid": "logs-traces",
      "version": 1
    }
{{- end }}
