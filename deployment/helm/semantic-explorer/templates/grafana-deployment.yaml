{{- if .Values.observability.grafana.enabled }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "semantic-explorer.fullname" . }}-grafana
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "semantic-explorer.grafana.labels" . | nindent 4 }}
  {{- with .Values.commonAnnotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  replicas: 1
  selector:
    matchLabels:
      {{- include "semantic-explorer.grafana.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/grafana-datasources-configmap.yaml") . | sha256sum }}
        {{- with .Values.commonAnnotations }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      labels:
        {{- include "semantic-explorer.grafana.selectorLabels" . | nindent 8 }}
    spec:
      {{- with .Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      securityContext:
        {{- toYaml .Values.observability.grafana.podSecurityContext | nindent 8 }}
      containers:
      - name: grafana
        image: {{ include "semantic-explorer.grafana.image" . }}
        imagePullPolicy: {{ .Values.observability.grafana.image.pullPolicy }}
        securityContext:
          {{- toYaml .Values.observability.grafana.containerSecurityContext | nindent 10 }}
        ports:
        - name: http
          containerPort: {{ .Values.observability.grafana.service.port }}
          protocol: TCP
        env:
        - name: GF_SECURITY_ADMIN_USER
          valueFrom:
            secretKeyRef:
              name: {{ include "semantic-explorer.fullname" . }}-grafana-secrets
              key: {{ .Values.observability.grafana.admin.userKey }}
        - name: GF_SECURITY_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ include "semantic-explorer.fullname" . }}-grafana-secrets
              key: {{ .Values.observability.grafana.admin.passwordKey }}
        - name: GF_USERS_ALLOW_SIGN_UP
          value: {{ .Values.observability.grafana.config.usersAllowSignUp | quote }}
        - name: GF_INSTALL_PLUGINS
          value: {{ .Values.observability.grafana.config.installPlugins | quote }}
        - name: GF_PATHS_DATA
          value: /var/lib/grafana
        - name: GF_PATHS_LOGS
          value: /var/log/grafana
        - name: GF_PATHS_PLUGINS
          value: /var/lib/grafana/plugins
        - name: GF_PATHS_PROVISIONING
          value: /etc/grafana/provisioning
        livenessProbe:
          httpGet:
            path: /api/health
            port: http
          initialDelaySeconds: 60
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /api/health
            port: http
          initialDelaySeconds: 30
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
        resources:
          {{- toYaml .Values.observability.grafana.resources | nindent 10 }}
        volumeMounts:
        - name: data
          mountPath: /var/lib/grafana
        - name: logs
          mountPath: /var/log/grafana
        - name: datasources
          mountPath: /etc/grafana/provisioning/datasources
        - name: dashboards-provisioning
          mountPath: /etc/grafana/provisioning/dashboards
        {{- if .Values.observability.grafana.dashboards.enabled }}
        - name: dashboard-application-metrics
          mountPath: /var/lib/grafana/dashboards/application-metrics.json
          subPath: application-metrics.json
        - name: dashboard-database-nats
          mountPath: /var/lib/grafana/dashboards/database-nats.json
          subPath: database-nats.json
        - name: dashboard-infrastructure
          mountPath: /var/lib/grafana/dashboards/infrastructure.json
          subPath: infrastructure.json
        - name: dashboard-worker-metrics
          mountPath: /var/lib/grafana/dashboards/worker-metrics.json
          subPath: worker-metrics.json
        - name: dashboard-health-check
          mountPath: /var/lib/grafana/dashboards/health-check-dashboard.json
          subPath: health-check-dashboard.json
        {{- end }}
      volumes:
      - name: data
        {{- if .Values.observability.grafana.persistence.enabled }}
        persistentVolumeClaim:
          claimName: {{ include "semantic-explorer.fullname" . }}-grafana
        {{- else }}
        emptyDir: {}
        {{- end }}
      - name: logs
        emptyDir: {}
      - name: datasources
        configMap:
          name: {{ include "semantic-explorer.fullname" . }}-grafana-datasources
      - name: dashboards-provisioning
        configMap:
          name: {{ include "semantic-explorer.fullname" . }}-grafana-dashboards-provisioning
      {{- if .Values.observability.grafana.dashboards.enabled }}
      - name: dashboard-application-metrics
        configMap:
          name: {{ include "semantic-explorer.fullname" . }}-grafana-dashboard-application-metrics
      - name: dashboard-database-nats
        configMap:
          name: {{ include "semantic-explorer.fullname" . }}-grafana-dashboard-database-nats
      - name: dashboard-infrastructure
        configMap:
          name: {{ include "semantic-explorer.fullname" . }}-grafana-dashboard-infrastructure
      - name: dashboard-worker-metrics
        configMap:
          name: {{ include "semantic-explorer.fullname" . }}-grafana-dashboard-worker-metrics
      - name: dashboard-health-check
        configMap:
          name: {{ include "semantic-explorer.fullname" . }}-grafana-dashboard-health-check
      {{- end }}
{{- end }}
