{{- if and .Values.dex.enabled (not .Values.dex.external.enabled) }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "semantic-explorer.fullname" . }}-dex-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "semantic-explorer.dex.labels" . | nindent 4 }}
  {{- with .Values.commonAnnotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
data:
  config.yaml: |
    # Dex OIDC Provider Configuration
    # Generated by Helm chart
    
    issuer: {{ .Values.dex.config.issuer | default (printf "http://%s-dex:%d" (include "semantic-explorer.fullname" .) (int .Values.dex.service.port)) }}
    
    storage:
      {{- if eq .Values.dex.config.storage.type "kubernetes" }}
      type: kubernetes
      config:
        inCluster: true
      {{- else if eq .Values.dex.config.storage.type "sqlite3" }}
      type: sqlite3
      config:
        file: /var/dex/dex.db
      {{- else }}
      {{- toYaml .Values.dex.config.storage | nindent 6 }}
      {{- end }}
    
    web:
      http: {{ .Values.dex.config.web.http | default "0.0.0.0:5556" }}
    
    grpc:
      addr: 0.0.0.0:5557
    
    telemetry:
      http: 0.0.0.0:5558
    
    oauth2:
      skipApprovalScreen: {{ .Values.dex.config.oauth2.skipApprovalScreen | default true }}
    
    {{- if .Values.dex.config.staticClients }}
    staticClients:
    {{- range .Values.dex.config.staticClients }}
    - id: {{ .id | quote }}
      name: {{ .name | quote }}
      {{- if .secret }}
      secret: {{ .secret | quote }}
      {{- end }}
      redirectURIs:
      {{- range .redirectURIs }}
      - {{ . | quote }}
      {{- end }}
    {{- end }}
    {{- end }}
    
    {{- if .Values.dex.config.connectors }}
    connectors:
    {{- toYaml .Values.dex.config.connectors | nindent 4 }}
    {{- end }}
    
    {{- if .Values.dex.config.enablePasswordDB }}
    enablePasswordDB: {{ .Values.dex.config.enablePasswordDB }}
    {{- end }}
    
    {{- if .Values.dex.config.staticPasswords }}
    staticPasswords:
    {{- toYaml .Values.dex.config.staticPasswords | nindent 4 }}
    {{- end }}
{{- end }}
