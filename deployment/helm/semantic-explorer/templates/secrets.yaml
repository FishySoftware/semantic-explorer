apiVersion: v1
kind: Secret
metadata:
  name: {{ include "semantic-explorer.fullname" . }}-secrets
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "semantic-explorer.labels" . | nindent 4 }}
  {{- with .Values.commonAnnotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
type: Opaque
data:
  {{- if .Values.postgresql.external.enabled }}
  {{- if .Values.postgresql.external.existingSecret }}
  # Using existing PostgreSQL secret
  {{- else }}
  # PostgreSQL connection string
  database-url: {{ printf "postgresql://%s:%s@%s:%d/%s?sslmode=%s" 
    (.Values.postgresql.external.username) 
    (.Values.postgresql.external.password) 
    (.Values.postgresql.external.host) 
    (int .Values.postgresql.external.port) 
    (.Values.postgresql.external.database) 
    (.Values.postgresql.external.sslMode) | b64enc | quote }}
  {{- end }}
  {{- else }}
  # Internal PostgreSQL connection string
  {{- $dbPassword := .Values.postgresql.auth.password | default (randAlphaNum 16) }}
  database-url: {{ printf "postgresql://%s:%s@%s-postgresql:%d/%s"
    (include "semantic-explorer.postgresql.username" .)
    $dbPassword
    (include "semantic-explorer.fullname" .)
    5432
    (include "semantic-explorer.postgresql.database" .) | b64enc | quote }}
  database-password: {{ $dbPassword | b64enc | quote }}
  {{- end }}
  
  {{- if .Values.dex.external.enabled }}
  {{- if .Values.dex.external.existingSecret }}
  # Using existing OIDC secret
  {{- else }}
  # External OIDC credentials
  oidc-client-id: {{ .Values.dex.external.clientId | b64enc | quote }}
  oidc-client-secret: {{ .Values.dex.external.clientSecret | b64enc | quote }}
  {{- end }}
  {{- else }}
  # Internal Dex OIDC credentials
  {{- $staticClient := index .Values.dex.config.staticClients 0 | default (dict "id" "semantic-explorer" "secret" "") }}
  oidc-client-id: {{ $staticClient.id | default "semantic-explorer" | b64enc | quote }}
  oidc-client-secret: {{ $staticClient.secret | default (randAlphaNum 32) | b64enc | quote }}
  {{- end }}
  
  {{- if .Values.storage.s3.existingSecret }}
  # Using existing S3 storage secret
  {{- else if .Values.minio.enabled }}
  # MinIO credentials are in {{ .Release.Name }}-minio secret (rootUser/rootPassword)
  # This placeholder ensures other components using storage.s3 config still work
  # Components that need MinIO should reference {{ .Release.Name }}-minio secret directly
  aws-access-key-id: {{ "minio-use-minio-secret" | b64enc | quote }}
  aws-secret-access-key: {{ "minio-use-minio-secret" | b64enc | quote }}
  {{- else }}
  # S3/Storage credentials
  aws-access-key-id: {{ .Values.storage.s3.accessKeyId | default "test_access_key" | b64enc | quote }}
  aws-secret-access-key: {{ .Values.storage.s3.secretAccessKey | default "test_secret_key" | b64enc | quote }}
  {{- end }}

  # API Key Encryption Master Key (AES-256-GCM)
  # IMPORTANT: Must be a 64-character hex string (256-bit key)
  # Store securely in secret management system (AWS Secrets Manager, HashiCorp Vault, etc.)
  {{- $existingSecret := lookup "v1" "Secret" .Release.Namespace (printf "%s-secrets" (include "semantic-explorer.fullname" .)) }}
  {{- if .Values.encryption.masterKey }}
  {{- /* Use the key provided in values.yaml */}}
  encryption-master-key: {{ .Values.encryption.masterKey | b64enc | quote }}
  {{- else if and $existingSecret (index $existingSecret.data "encryption-master-key") }}
  {{- /* Reuse existing key from previous deployment to maintain stability */}}
  encryption-master-key: {{ index $existingSecret.data "encryption-master-key" | quote }}
  {{- else }}
  {{- /* Generate a new random 256-bit key (equivalent to: openssl rand -hex 32) */}}
  {{- /* WARNING: This key will be regenerated on each helm template/upgrade without lookup */}}
  encryption-master-key: {{ randAlphaNum 64 | lower | b64enc | quote }}
  {{- end }}

---
{{- if and .Values.valkey.external.enabled (not .Values.valkey.external.existingSecret) }}
# External Valkey password secret
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "semantic-explorer.fullname" . }}-valkey-external
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "semantic-explorer.labels" . | nindent 4 }}
  {{- with .Values.commonAnnotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
type: Opaque
data:
  password: {{ .Values.valkey.external.password | b64enc | quote }}
{{- end }}