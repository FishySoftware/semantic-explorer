apiVersion: v1
kind: Secret
metadata:
  name: {{ include "semantic-explorer.fullname" . }}-secrets
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "semantic-explorer.labels" . | nindent 4 }}
  {{- with .Values.commonAnnotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
type: Opaque
data:
  {{- /* ================================================================= */}}
  {{- /* Lookup existing secret to preserve auto-generated values across   */}}
  {{- /* helm upgrades. Without this, randAlphaNum generates new values    */}}
  {{- /* on every upgrade.                                                 */}}
  {{- /* ================================================================= */}}
  {{- $existingSecret := lookup "v1" "Secret" .Release.Namespace (printf "%s-secrets" (include "semantic-explorer.fullname" .)) }}

  {{- /* ================================================================= */}}
  {{- /* POSTGRESQL                                                        */}}
  {{- /* ================================================================= */}}
  {{- if .Values.postgresql.external.enabled }}
  {{- if .Values.postgresql.external.existingSecret }}
  # Using existing PostgreSQL secret
  {{- else }}
  database-url: {{ printf "postgresql://%s:%s@%s:%d/%s?sslmode=%s" 
    (.Values.postgresql.external.username) 
    (.Values.postgresql.external.password) 
    (.Values.postgresql.external.host) 
    (int .Values.postgresql.external.port) 
    (.Values.postgresql.external.database) 
    (.Values.postgresql.external.sslMode) | b64enc | quote }}
  {{- end }}
  {{- else }}
  {{- $dbPassword := "" }}
  {{- if .Values.postgresql.auth.password }}
  {{- $dbPassword = .Values.postgresql.auth.password }}
  {{- else if and $existingSecret (index $existingSecret.data "database-password") }}
  {{- $dbPassword = index $existingSecret.data "database-password" | b64dec }}
  {{- else }}
  {{- $dbPassword = randAlphaNum 24 }}
  {{- end }}
  database-url: {{ printf "postgresql://%s:%s@%s-postgresql:%d/%s"
    (include "semantic-explorer.postgresql.username" .)
    $dbPassword
    (include "semantic-explorer.fullname" .)
    5432
    (include "semantic-explorer.postgresql.database" .) | b64enc | quote }}
  database-password: {{ $dbPassword | b64enc | quote }}
  {{- end }}
  
  {{- /* ================================================================= */}}
  {{- /* OIDC (DEX)                                                        */}}
  {{- /* ================================================================= */}}
  {{- if .Values.dex.external.enabled }}
  {{- if .Values.dex.external.existingSecret }}
  # Using existing OIDC secret
  {{- else }}
  oidc-client-id: {{ .Values.dex.external.clientId | b64enc | quote }}
  oidc-client-secret: {{ .Values.dex.external.clientSecret | b64enc | quote }}
  {{- end }}
  {{- else }}
  {{- $staticClient := index .Values.dex.config.staticClients 0 | default (dict "id" "semantic-explorer" "secret" "") }}
  oidc-client-id: {{ $staticClient.id | default "semantic-explorer" | b64enc | quote }}
  {{- $oidcSecret := "" }}
  {{- if $staticClient.secret }}
  {{- $oidcSecret = $staticClient.secret }}
  {{- else if and $existingSecret (index $existingSecret.data "oidc-client-secret") }}
  {{- $oidcSecret = index $existingSecret.data "oidc-client-secret" | b64dec }}
  {{- else }}
  {{- $oidcSecret = randAlphaNum 32 }}
  {{- end }}
  oidc-client-secret: {{ $oidcSecret | b64enc | quote }}
  {{- end }}
  
  {{- /* ================================================================= */}}
  {{- /* S3 / STORAGE                                                      */}}
  {{- /* ================================================================= */}}
  {{- if .Values.storage.s3.existingSecret }}
  # Using existing S3 storage secret
  {{- else if .Values.minio.enabled }}
  # MinIO credentials â€” referenced from the minio secret below
  aws-access-key-id: {{ "minio-use-minio-secret" | b64enc | quote }}
  aws-secret-access-key: {{ "minio-use-minio-secret" | b64enc | quote }}
  {{- else }}
  aws-access-key-id: {{ .Values.storage.s3.accessKeyId | default "test_access_key" | b64enc | quote }}
  aws-secret-access-key: {{ .Values.storage.s3.secretAccessKey | default "test_secret_key" | b64enc | quote }}
  {{- end }}

  {{- /* ================================================================= */}}
  {{- /* ENCRYPTION MASTER KEY                                             */}}
  {{- /* ================================================================= */}}
  {{- if .Values.encryption.masterKey }}
  encryption-master-key: {{ .Values.encryption.masterKey | b64enc | quote }}
  {{- else if and $existingSecret (index $existingSecret.data "encryption-master-key") }}
  encryption-master-key: {{ index $existingSecret.data "encryption-master-key" | quote }}
  {{- else }}
  encryption-master-key: {{ randAlphaNum 64 | lower | b64enc | quote }}
  {{- end }}

  {{- /* ================================================================= */}}
  {{- /* VALKEY PASSWORD                                                   */}}
  {{- /* Auto-generated and shared with the Valkey subchart via            */}}
  {{- /* valkey.auth.usersExistingSecret                                   */}}
  {{- /* ================================================================= */}}
  {{- if or .Values.valkey.enabled (not .Values.valkey.external.enabled) }}
  {{- $valkeyPassword := "" }}
  {{- if .Values.valkey.auth.aclUsers }}
  {{- $defaultUser := index .Values.valkey.auth.aclUsers "default" | default dict }}
  {{- if $defaultUser.password }}
  {{- $valkeyPassword = $defaultUser.password }}
  {{- end }}
  {{- end }}
  {{- if not $valkeyPassword }}
  {{- if and $existingSecret (index $existingSecret.data "valkey-password") }}
  {{- $valkeyPassword = index $existingSecret.data "valkey-password" | b64dec }}
  {{- else }}
  {{- $valkeyPassword = randAlphaNum 24 }}
  {{- end }}
  {{- end }}
  valkey-password: {{ $valkeyPassword | b64enc | quote }}
  {{- end }}

  {{- /* ================================================================= */}}
  {{- /* MINIO / GRAFANA                                                   */}}
  {{- /* These subcharts auto-generate their credentials when no           */}}
  {{- /* rootPassword / adminPassword is set.  No need to duplicate here.  */}}
  {{- /* ================================================================= */}}

---
{{- if and .Values.valkey.external.enabled (not .Values.valkey.external.existingSecret) }}
# External Valkey password secret
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "semantic-explorer.fullname" . }}-valkey-external
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "semantic-explorer.labels" . | nindent 4 }}
  {{- with .Values.commonAnnotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
type: Opaque
data:
  password: {{ .Values.valkey.external.password | b64enc | quote }}
{{- end }}