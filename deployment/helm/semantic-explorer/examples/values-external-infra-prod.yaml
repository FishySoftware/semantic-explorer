# Production Environment - External Infrastructure
# This values file disables all infrastructure services and requires external configurations
# All external services are accessed via provided endpoints - designed for cloud deployments
# Use with: helm install semantic-explorer . -f examples/values-external-infra-prod.yaml

global:
  environment: production
  # Init container image for startup ordering
  initContainer:
    image: "busybox:1.36"

# API Service - Production
api:
  enabled: true
  replicaCount: 4
  image:
    tag: "latest"
  resources:
    requests:
      cpu: 2000m
      memory: 2Gi
    limits:
      cpu: 4000m
      memory: 4Gi
  autoscaling:
    enabled: true
    minReplicas: 4
    maxReplicas: 10
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80
  podDisruptionBudget:
    enabled: true
    minAvailable: 2
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true
      interval: 15s
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchExpressions:
                - key: app.kubernetes.io/name
                  operator: In
                  values:
                    - api
            topologyKey: kubernetes.io/hostname
  # Environment variables for external services
  env:
    DATABASE_URL: "postgres://user:password@postgres.prod.example.com:5432/semantic_explorer"
    REDIS_URL: "redis://redis-primary.prod.example.com:6379"
    NATS_URL: "nats://nats1.prod.example.com:4222,nats2.prod.example.com:4222,nats3.prod.example.com:4222"
    QDRANT_URL: "http://qdrant.prod.example.com:6333"
    S3_BUCKET: "semantic-explorer-prod"
    S3_ENDPOINT: "https://s3.prod.example.com"
    OTEL_EXPORTER_OTLP_ENDPOINT: "http://observability.prod.example.com:4317"

# Worker Collections - Production
workerCollections:
  enabled: true
  replicaCount: 4
  resources:
    requests:
      cpu: 2000m
      memory: 1Gi
    limits:
      cpu: 4000m
      memory: 2Gi
  autoscaling:
    enabled: true
    minReplicas: 4
    maxReplicas: 8
  podDisruptionBudget:
    enabled: true
    minAvailable: 2
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true
      interval: 15s
  env:
    DATABASE_URL: "postgres://user:password@postgres.prod.example.com:5432/semantic_explorer"
    NATS_URL: "nats://nats1.prod.example.com:4222,nats2.prod.example.com:4222,nats3.prod.example.com:4222"
    OTEL_EXPORTER_OTLP_ENDPOINT: "http://observability.prod.example.com:4317"

# Worker Datasets - Production
workerDatasets:
  enabled: true
  replicaCount: 4
  resources:
    requests:
      cpu: 2000m
      memory: 2Gi
    limits:
      cpu: 4000m
      memory: 8Gi
  autoscaling:
    enabled: true
    minReplicas: 4
    maxReplicas: 12
  podDisruptionBudget:
    enabled: true
    minAvailable: 2
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true
      interval: 15s
  env:
    DATABASE_URL: "postgres://user:password@postgres.prod.example.com:5432/semantic_explorer"
    NATS_URL: "nats://nats1.prod.example.com:4222,nats2.prod.example.com:4222,nats3.prod.example.com:4222"
    QDRANT_URL: "http://qdrant.prod.example.com:6333"
    OTEL_EXPORTER_OTLP_ENDPOINT: "http://observability.prod.example.com:4317"

# Worker Visualizations - Production
workerVisualizationsPy:
  enabled: true
  replicaCount: 4
  resources:
    requests:
      cpu: 2000m
      memory: 2Gi
    limits:
      cpu: 4000m
      memory: 8Gi
  autoscaling:
    enabled: true
    minReplicas: 4
    maxReplicas: 12
    targetCPUUtilizationPercentage: 70
  podDisruptionBudget:
    enabled: true
    minAvailable: 2
  env:
    NATS_URL: "nats://nats1.prod.example.com:4222,nats2.prod.example.com:4222,nats3.prod.example.com:4222"
    QDRANT_URL: "http://qdrant.prod.example.com:6333"
    S3_BUCKET: "semantic-explorer-prod"
    S3_ENDPOINT: "https://s3.prod.example.com"
    OTEL_EXPORTER_OTLP_ENDPOINT: "http://observability.prod.example.com:4317"

# All infrastructure services DISABLED - using external managed services
postgresql:
  enabled: false
  external:
    enabled: true
    host: "postgres.prod.example.com"
    port: 5432
    database: semantic_explorer
    username: user
    existingSecret: "external-postgresql-secret"
    passwordKey: "password"
    sslMode: verify-full

redis:
  enabled: false
  external:
    enabled: true
    clusterNodes: "redis://redis-primary.prod.example.com:6379"
    existingSecret: "external-redis-secret"
    passwordKey: "password"

nats:
  enabled: false
  external:
    enabled: true
    url: "nats://nats1.prod.example.com:4222,nats2.prod.example.com:4222,nats3.prod.example.com:4222"

qdrant:
  enabled: false
  external:
    enabled: true
    url: "http://qdrant.prod.example.com:6333"
    existingSecret: "external-qdrant-secret"
    apiKeyKey: "api-key"

minio:
  enabled: false
  external:
    enabled: true
    endpoint: "https://s3.prod.example.com"
    region: "us-east-1"
    bucket: "semantic-explorer-prod"
    existingSecret: "external-s3-secret"
    accessKeyIdKey: "access-key-id"
    secretAccessKeyKey: "secret-access-key"

# Storage Configuration (S3-compatible)
storage:
  s3:
    endpoint: "https://s3.prod.example.com"
    region: "us-east-1"
    bucketName: "semantic-explorer-prod"
    existingSecret: "external-s3-secret"
    accessKeyIdKey: "access-key-id"
    secretAccessKeyKey: "secret-access-key"

# Dex - OIDC Provider
dex:
  enabled: true
  resources:
    requests:
      cpu: 200m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
  podDisruptionBudget:
    enabled: true
    minAvailable: 1

# Observability - Optional local aggregation
# If your cloud provider has a managed observability service, disable this
observability:
  otelCollector:
    enabled: false  # Set to true if you want local collection/aggregation

  # Use external Prometheus instance
  prometheus:
    enabled: false
    external:
      enabled: true
      url: "http://prometheus.prod.example.com:9090"

  quickwit:
    enabled: false  # Typically managed externally in production
    external:
      enabled: true
      url: "http://quickwit.prod.example.com:7280"

# Prometheus subchart - Disabled when using external
prometheus:
  enabled: false

# Grafana subchart - Disabled when using external
grafana:
  enabled: false
  external:
    enabled: true
    url: "http://grafana.prod.example.com:3000"

# Network Policy
networkPolicy:
  enabled: true
  ingress:
    fromIngress: true
  egress:
    toDns: true
    toInternet: true  # Required to reach external services

# ============================================================================
# REQUIRED EXTERNAL SERVICE CONFIGURATIONS
# ============================================================================
#
# Before deploying with this values file, you must provide credentials and
# connection details for all external services. Create secrets:
#
# kubectl create secret generic external-postgresql-secret \
#   --from-literal=password="your-postgres-password"
#
# kubectl create secret generic external-redis-secret \
#   --from-literal=password="your-redis-password"
#
# kubectl create secret generic external-qdrant-secret \
#   --from-literal=api-key="your-qdrant-api-key"
#
# kubectl create secret generic external-s3-secret \
#   --from-literal=access-key-id="your-access-key" \
#   --from-literal=secret-access-key="your-secret-key"
#
# Required External Services:
# 1. PostgreSQL 14+ with automatic failover (RDS Multi-AZ, CloudSQL HA, etc.)
# 2. Redis Cluster (3+ nodes) with high availability
# 3. NATS JetStream Cluster (3+ nodes) with persistent storage
# 4. Qdrant Vector Database (3+ replicas) with API authentication
# 5. S3-Compatible Storage with versioning and lifecycle policies
# 6. Observability backend (optional - Datadog, New Relic, CloudWatch, etc.)
#
# Example AWS Setup:
#   - RDS PostgreSQL 14 (Multi-AZ)
#   - ElastiCache Redis Cluster
#   - Amazon MQ for NATS (or self-managed EKS cluster)
#   - Managed Qdrant (or EC2 deployment)
#   - S3 for object storage
#   - CloudWatch or DataDog for observability
#
# Example GCP Setup:
#   - Cloud SQL PostgreSQL
#   - Memorystore Redis Cluster
#   - Cloud Tasks (alternative to NATS)
#   - Vertex AI Vector Search (alternative to Qdrant)
#   - Cloud Storage for object storage
#   - Cloud Logging and Cloud Trace
#
# Example Azure Setup:
#   - Azure Database for PostgreSQL
#   - Azure Cache for Redis Enterprise Cluster
#   - Service Bus (alternative to NATS)
#   - Azure Cognitive Search (alternative to Qdrant)
#   - Azure Blob Storage
#   - Azure Monitor and Application Insights
#
# ============================================================================
