# Air-Gapped RKE2 Production Environment - All Infrastructure Included
# This values file is designed for air-gapped Kubernetes RKE2 deployments with:
# - NO ROOT containers (all containers run as non-root)
# - NO CRDs (ServiceMonitors disabled)
# - NO RBAC (ClusterRoles, Roles, RoleBindings disabled where possible)
# - NO Operators required
# - ALL infrastructure deployed with the chart (PostgreSQL, NATS, Qdrant, MinIO, etc.)
#
# Prerequisites:
# 1. Push all required images to your internal registry
# 2. Ensure storage class exists in your cluster
# 3. Pre-create ServiceAccounts if rbac.create is disabled on subcharts
#
# Use with: helm install semantic-explorer . -f examples/values-airgapped-rke2-all-included.yaml

global:
  # IMPORTANT: Set this to your internal/private registry
  imageRegistry: "registry.internal.example.com"
  imagePullSecrets:
    - name: registry-credentials
  storageClass: "local-path"  # Change to your RKE2 storage class
  environment: production
  # Secure init container (non-root)
  initContainer:
    image: "library/busybox:1.36"  # Ensure this is in your internal registry
  securityContext:
    runAsNonRoot: true
    runAsUser: 10001
    runAsGroup: 10001
    fsGroup: 10001
    fsGroupChangePolicy: "OnRootMismatch"
    seccompProfile:
      type: RuntimeDefault
  podSecurityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL
    readOnlyRootFilesystem: true
  networkPolicy:
    enabled: true
  serviceMesh:
    enabled: false

# ============================================================================
# APPLICATION SERVICES
# ============================================================================

# API Service - Production
api:
  enabled: true
  replicaCount: 3
  image:
    repository: jofish89/semantic-explorer
    tag: "latest"
    pullPolicy: IfNotPresent  # Use IfNotPresent for air-gapped
  resources:
    requests:
      cpu: 1000m
      memory: 1Gi
    limits:
      cpu: 4000m
      memory: 4Gi
  autoscaling:
    enabled: false  # HPA requires metrics-server, disable if not available
  podDisruptionBudget:
    enabled: true
    minAvailable: 1
  serviceAccount:
    create: true
    annotations: {}
    name: "sa-semantic-explorer-api"
  # DISABLE ServiceMonitor (requires Prometheus Operator CRD)
  metrics:
    enabled: true
    serviceMonitor:
      enabled: false  # DISABLED - requires ServiceMonitor CRD
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchExpressions:
                - key: app.kubernetes.io/name
                  operator: In
                  values:
                    - api
            topologyKey: kubernetes.io/hostname

# Worker Collections - Production
workerCollections:
  enabled: true
  replicaCount: 3
  image:
    repository: jofish89/worker-collections
    tag: "latest"
    pullPolicy: IfNotPresent
  resources:
    requests:
      cpu: 1000m
      memory: 1Gi
    limits:
      cpu: 4000m
      memory: 2Gi
  autoscaling:
    enabled: false
  podDisruptionBudget:
    enabled: true
    minAvailable: 1
  serviceAccount:
    create: true
    annotations: {}
    name: "sa-semantic-explorer-worker-collections"
  # DISABLE ServiceMonitor
  metrics:
    enabled: true
    serviceMonitor:
      enabled: false  # DISABLED - requires ServiceMonitor CRD

# Worker Datasets - Production
workerDatasets:
  enabled: true
  replicaCount: 3
  image:
    repository: jofish89/worker-datasets
    tag: "latest"
    pullPolicy: IfNotPresent
  resources:
    requests:
      cpu: 1000m
      memory: 2Gi
    limits:
      cpu: 4000m
      memory: 8Gi
  autoscaling:
    enabled: false
  podDisruptionBudget:
    enabled: true
    minAvailable: 1
  serviceAccount:
    create: true
    annotations: {}
    name: "sa-semantic-explorer-worker-datasets"
  # DISABLE ServiceMonitor
  metrics:
    enabled: true
    serviceMonitor:
      enabled: false  # DISABLED - requires ServiceMonitor CRD

# Worker Visualizations - Production
workerVisualizationsPy:
  enabled: true
  replicaCount: 2
  image:
    repository: jofish89/worker-visualizations-py
    tag: "latest"
    pullPolicy: IfNotPresent
  resources:
    requests:
      cpu: 1000m
      memory: 2Gi
    limits:
      cpu: 4000m
      memory: 8Gi
  autoscaling:
    enabled: false
  podDisruptionBudget:
    enabled: true
    minAvailable: 1
  serviceAccount:
    create: true
    annotations: {}
    name: "sa-semantic-explorer-worker-visualizations-py"
  metrics:
    enabled: false

# ============================================================================
# INFRASTRUCTURE - ALL DEPLOYED WITH CHART
# ============================================================================

# PostgreSQL - Internal Deployment
postgresql:
  enabled: true
  external:
    enabled: false
  image:
    repository: postgres
    tag: "16.3-alpine"
    pullPolicy: IfNotPresent
  auth:
    database: semantic_explorer
    username: semantic_explorer
    password: ""  # Will be auto-generated if empty
  primary:
    resources:
      requests:
        cpu: 500m
        memory: 512Mi
      limits:
        cpu: 2000m
        memory: 2Gi
    persistence:
      enabled: true
      size: 50Gi
    # Non-root security context (PostgreSQL runs as uid 999)
    podSecurityContext:
      runAsNonRoot: true
      runAsUser: 999
      fsGroup: 999
      fsGroupChangePolicy: "OnRootMismatch"
    containerSecurityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop:
          - ALL
      readOnlyRootFilesystem: false  # PostgreSQL needs writable filesystem
  backup:
    enabled: false
  metrics:
    enabled: false  # Disable metrics exporter

  enabled: true
  # DISABLE RBAC - requires cluster permissions
  rbac:
    create: false  # DISABLED for air-gapped - no Role/RoleBinding created
  replicas: 3
  serviceAccount:
    create: true
    automountToken: false
    port: 6379
    masterGroupName: "mymaster"
    config:
      maxmemory: "256mb"
      maxmemory-policy: "allkeys-lru"
      save: "900 1 300 10"
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi
  sentinel:
    port: 26379
    quorum: 2
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 200m
        memory: 128Mi
  auth: false  # Disable auth for simpler setup
  haproxy:
    enabled: true
    replicas: 2
    servicePort: 6379
    serviceAccount:
      create: true
      automountToken: false
  image:
    tag: "7.2-alpine"
    pullPolicy: IfNotPresent
  persistence:
    enabled: true
    size: 5Gi
  # Non-root security context
  securityContext:
    runAsUser: 1000
    fsGroup: 1000
    runAsNonRoot: true
  containerSecurityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL
  exporter:
    enabled: false  # Disable exporter for air-gapped

# NATS - Internal Deployment (JetStream enabled)
nats:
  enabled: true
  external:
    enabled: false
  image:
    repository: nats
    tag: "2.10-alpine"
    pullPolicy: IfNotPresent
  # NATS doesn't create RBAC by default
  serviceAccount:
    enabled: false
  natsBox:
    enabled: false  # Disable nats-box for air-gapped
  config:
    jetstream:
      enabled: true
      fileStore:
        maxSize: 10Gi
    cluster:
      enabled: true
      replicas: 3
  resources:
    requests:
      cpu: 500m
      memory: 512Mi
    limits:
      cpu: 2000m
      memory: 2Gi
  persistence:
    enabled: true
    size: 10Gi
  # Non-root security context
  container:
    merge:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        allowPrivilegeEscalation: false
        capabilities:
          drop:
            - ALL
  podTemplate:
    merge:
      spec:
        securityContext:
          runAsNonRoot: true
          runAsUser: 1000
          fsGroup: 1000
          fsGroupChangePolicy: "OnRootMismatch"
  metrics:
    enabled: false  # Disable prometheus metrics

# Qdrant - Internal Deployment (Vector Database)
qdrant:
  enabled: true
  external:
    enabled: false
  image:
    repository: qdrant/qdrant
    tag: "v1.16.3"
    pullPolicy: IfNotPresent
  replicaCount: 3
  cluster:
    enabled: true
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 2000m
      memory: 4Gi
  persistence:
    enabled: true
    size: 50Gi
  service:
    type: ClusterIP
    http:
      port: 6333
    grpc:
      port: 6334
  # Non-root security context (Qdrant runs as uid 1000)
  updateVolumeFsOwnership: false
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 1000
    fsGroup: 1000
  containerSecurityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL
    readOnlyRootFilesystem: false  # Qdrant needs writable filesystem
  # DISABLE ServiceMonitor
  metrics:
    enabled: false
    serviceMonitor:
      enabled: false

# MinIO - Internal Deployment (S3-compatible storage)
minio:
  enabled: true
  external:
    enabled: false
  image:
    repository: minio/minio
    tag: "RELEASE.2024-01-16T16-07-38Z"  # Pin specific version
    pullPolicy: IfNotPresent
  # Standalone mode for simpler deployment
  mode: standalone
  replicas: 1
  rootUser: admin
  rootPassword: ""  # Will be auto-generated if empty
  resources:
    requests:
      cpu: 500m
      memory: 512Mi
    limits:
      cpu: 2000m
      memory: 2Gi
  persistence:
    enabled: true
    size: 100Gi
  service:
    type: ClusterIP
    port: 9000
    consolePort: 9001
  # Non-root security context (MinIO runs as uid 1000)
  securityContext:
    enabled: true
    runAsUser: 1000
    runAsGroup: 1000
    fsGroup: 1000
    fsGroupChangePolicy: "OnRootMismatch"
    readOnlyRootFilesystem: false
  # Disable console ingress
  consoleIngress:
    enabled: false
  ingress:
    enabled: false
  # Auto-create buckets
  buckets:
    - name: semantic-explorer-files
      policy: none
      purge: false
    - name: quickwit
      policy: none
      purge: false
  # Job security context (make bucket job)
  makeBucketJob:
    securityContext:
      enabled: true
      runAsUser: 1000
      runAsGroup: 1000
  makeServiceAccountJob:
    securityContext:
      enabled: true
      runAsUser: 1000
      runAsGroup: 1000
  makeUserJob:
    securityContext:
      enabled: true
      runAsUser: 1000
      runAsGroup: 1000
  makePolicyJob:
    securityContext:
      enabled: true
      runAsUser: 1000
      runAsGroup: 1000
  customCommandJob:
    securityContext:
      enabled: true
      runAsUser: 1000
      runAsGroup: 1000

# Storage Configuration (points to internal MinIO)
storage:
  s3:
    endpoint: ""  # Will be auto-configured to MinIO service
    region: "us-east-1"
    bucketName: "semantic-explorer-files"
    accessKeyId: ""
    secretAccessKey: ""

# Encryption Configuration
encryption:
  # REQUIRED: Set a proper master key for production
  # Generate with: openssl rand -hex 32
  masterKey: ""  # Set this or it will use a placeholder

# Dex - OIDC Provider (Internal Deployment)
dex:
  enabled: true
  external:
    enabled: false
  image:
    repository: dexidp/dex
    tag: "v2.38.0"  # Pin specific version
    pullPolicy: IfNotPresent
  config:
    issuer: "http://dex.semantic-explorer.svc.cluster.local:5556"
    storage:
      type: kubernetes
      config:
        inCluster: true
    web:
      http: 0.0.0.0:5556
    oauth2:
      skipApprovalScreen: true
    staticClients:
      - id: semantic-explorer
        redirectURIs:
          - "http://localhost:8080/auth/callback"
        name: "Semantic Explorer"
        secret: ""  # Will be auto-generated
    connectors: []
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 256Mi
  service:
    type: ClusterIP
    port: 5556
  # Non-root security context
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 1001
    fsGroup: 1001
    fsGroupChangePolicy: "OnRootMismatch"
  containerSecurityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL
    readOnlyRootFilesystem: true

# ============================================================================
# OBSERVABILITY - Minimal setup without CRDs/RBAC
# ============================================================================

observability:
  # OpenTelemetry Collector - enabled for metrics/tracing aggregation
  otelCollector:
    enabled: true
    image:
      repository: otel/opentelemetry-collector-contrib
      tag: "0.92.0"  # Pin specific version
      pullPolicy: IfNotPresent
    resources:
      requests:
        cpu: 200m
        memory: 256Mi
      limits:
        cpu: 1000m
        memory: 1Gi
    # Non-root security context
    podSecurityContext:
      runAsNonRoot: true
      runAsUser: 10001
      fsGroup: 10001
      fsGroupChangePolicy: "OnRootMismatch"
    containerSecurityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop:
          - ALL
      readOnlyRootFilesystem: true
    config:
      extensions:
        health_check:
          endpoint: 0.0.0.0:13133
      receivers:
        otlp:
          protocols:
            grpc:
              endpoint: 0.0.0.0:4317
              max_recv_msg_size_mib: 100
            http:
              endpoint: 0.0.0.0:4318
      processors:
        batch:
          timeout: 10s
          send_batch_size: 1024
        memory_limiter:
          check_interval: 1s
          limit_mib: 512
          spike_limit_mib: 128
      exporters:
        prometheus:
          endpoint: "0.0.0.0:8889"
        logging:
          verbosity: normal
          sampling_initial: 5
          sampling_thereafter: 200
        # Export to Quickwit when enabled
        otlp/quickwit:
          endpoint: "{{ include \"semantic-explorer.fullname\" . }}-quickwit:7281"
          tls:
            insecure: true
          retry_on_failure:
            enabled: true
            initial_interval: 5s
            max_interval: 30s
            max_elapsed_time: 300s
          sending_queue:
            enabled: true
            num_consumers: 10
            queue_size: 5000
      service:
        extensions: [health_check]
        pipelines:
          metrics:
            receivers: [otlp]
            processors: [memory_limiter, batch]
            exporters: [prometheus, logging]
          traces:
            receivers: [otlp]
            processors: [memory_limiter, batch]
            exporters: [otlp/quickwit, logging]
          logs:
            receivers: [otlp]
            processors: [memory_limiter, batch]
            exporters: [otlp/quickwit, logging]

  # Prometheus - DISABLED (creates ClusterRole/ClusterRoleBinding)
  # Use OTEL Collector's prometheus exporter instead
  prometheus:
    enabled: false

  # Quickwit - Internal Deployment for logs/traces
  quickwit:
    enabled: true
    external:
      enabled: false
    image:
      repository: quickwit/quickwit
      tag: "0.8.1"  # Pin specific version
      pullPolicy: IfNotPresent
    replicaCount: 2
    storage:
      bucketName: "quickwit"
    config:
      enableOtlpEndpoint: true
      logLevel: "info"
    resources:
      requests:
        cpu: 500m
        memory: 1Gi
      limits:
        cpu: 2000m
        memory: 4Gi
    persistence:
      enabled: true
      size: 50Gi
    service:
      type: ClusterIP
      rest:
        port: 7280
      grpc:
        port: 7281
    # Non-root security context
    podSecurityContext:
      runAsNonRoot: true
      runAsUser: 1000
      fsGroup: 1000
      fsGroupChangePolicy: "OnRootMismatch"
    containerSecurityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop:
          - ALL
      readOnlyRootFilesystem: false
    # DISABLE ServiceMonitor
    metrics:
      enabled: false
      serviceMonitor:
        enabled: false

# ============================================================================
# SUBCHARTS WITH RBAC - DISABLED
# ============================================================================

# Prometheus subchart - DISABLED (creates ClusterRole/ClusterRoleBinding)
prometheus:
  enabled: false

# Grafana subchart - DISABLED (creates ClusterRole/Role/RoleBindings, runs root init container)
# Access Quickwit directly for log viewing, or deploy Grafana separately with proper RBAC
grafana:
  enabled: false

# Network Policy - enabled for security
networkPolicy:
  enabled: true
  ingress:
    fromIngress: true
    fromNamespaces: []
    fromPods: []
  egress:
    toDns: true
    toInternet: false  # Disable for air-gapped
    toNamespaces: []
    toCidr:
      - 10.0.0.0/8      # Allow internal network
      - 172.16.0.0/12   # Allow internal network
      - 192.168.0.0/16  # Allow internal network

# Common labels and annotations
commonLabels:
  environment: production
  deployment-type: airgapped-all-included

commonAnnotations: {}

# ============================================================================
# REQUIRED IMAGES - Push to internal registry before deployment
# ============================================================================
#
# Core application images:
#   - jofish89/semantic-explorer:latest
#   - jofish89/worker-collections:latest
#   - jofish89/worker-datasets:latest
#   - jofish89/worker-visualizations-py:latest
#
# Infrastructure images:
#   - library/busybox:1.36
#   - postgres:16.3-alpine
#   - nats:2.10-alpine
#   - qdrant/qdrant:v1.16.3
#   - minio/minio:RELEASE.2024-01-16T16-07-38Z
#   - dexidp/dex:v2.38.0
#   - otel/opentelemetry-collector-contrib:0.92.0
#   - quickwit/quickwit:0.8.1
#
#   - haproxy:2.9-alpine
#
# Example mirroring commands:
#   skopeo copy docker://docker.io/postgres:16.3-alpine \
#     docker://registry.internal.example.com/postgres:16.3-alpine
#
#   skopeo copy docker://docker.io/qdrant/qdrant:v1.16.3 \
#     docker://registry.internal.example.com/qdrant/qdrant:v1.16.3
#
# ============================================================================

# ============================================================================
# DEPLOYMENT NOTES
# ============================================================================
#
# 1. Update global.imageRegistry to your internal registry
#
# 2. Create imagePullSecret:
#    kubectl create secret generic registry-credentials \
#      --type=kubernetes.io/dockerconfigjson \
#      --from-file=.dockerconfigjson=/path/to/config.json
#
# 3. Set encryption master key (REQUIRED for production):
#    encryption:
#      masterKey: "your-64-char-hex-key"  # openssl rand -hex 32
#
# 4. Deploy:
#    helm install semantic-explorer . \
#      -f examples/values-airgapped-rke2-all-included.yaml \
#      -n semantic-explorer --create-namespace
#
#    with appropriate permissions if leader election is needed.
#    For simpler setup, the chart will still work but may have reduced HA
#    capabilities in some failure scenarios.
#
# ============================================================================
