# ================================
# Service Configuration
# ================================
SERVICE_NAME=worker-datasets

# ================================
# PostgreSQL Database Configuration
# ================================
DATABASE_URL=postgresql://semantic_explorer_user:semantic_explorer_password@localhost:5432/semantic_explorer

# ================================
# NATS Configuration
# ================================
NATS_URL=nats://localhost:4222

# ================================
# Qdrant Vector Database Configuration
# ================================
QDRANT_URL=http://localhost:6334
QDRANT_API_KEY=

# ================================
# Worker Configuration
# ================================
# Number of concurrent jobs (should match embedding capacity)
MAX_CONCURRENT_JOBS=8

# Batch sizes
WORKER_DATASET_BATCH_SIZE=1000         # Batch size for dataset processing
WORKER_QDRANT_UPLOAD_CHUNK_SIZE=200    # Chunk size for Qdrant vector uploads

# ================================
# Performance Tuning (NEW)
# ================================
# Parallel Qdrant uploads - controls concurrent chunk uploads (default: 4)
QDRANT_PARALLEL_UPLOADS=4

# Backpressure NAK delay in seconds when worker is at capacity (default: 30)
# Higher values reduce message churn when system is overloaded
WORKER_BACKPRESSURE_NAK_DELAY_SECS=30

# ================================
# Embedding Configuration
# ================================
# Max concurrent embedding API requests (should match GPU/inference capacity)
EMBEDDING_MAX_CONCURRENT_REQUESTS=5

# Delay between embedding sub-batches in ms (set to 0 for local inference with backpressure)
EMBEDDING_BATCH_DELAY_MS=0

# Max retries for embedding operations (default: 5)
WORKER_EMBEDDING_MAX_RETRIES=5

# NATS timeout configuration
NATS_CONNECTION_TIMEOUT_SECS=10        # NATS connection timeout
NATS_PING_INTERVAL_SECS=10             # NATS ping interval
NATS_STREAM_MAX_AGE_DAYS=7             # Max age for NATS stream messages
NATS_DATASET_TRANSFORM_ACK_WAIT_SECS=600  # Ack wait for dataset transforms (10 min)

# ================================
# NATS Consumer Tuning
# ================================
NATS_MAX_ACK_PENDING=100                    # Max unacknowledged messages per consumer
NATS_DATASET_ACK_WAIT_SECS=600              # Ack wait for dataset transforms (10 min)

# ================================
# Circuit Breaker Configuration
# ================================
QDRANT_CIRCUIT_BREAKER_FAILURE_THRESHOLD=5
QDRANT_CIRCUIT_BREAKER_SUCCESS_THRESHOLD=3
QDRANT_CIRCUIT_BREAKER_TIMEOUT_SECS=30
QDRANT_CIRCUIT_BREAKER_FAILURE_WINDOW_SECS=60

S3_CIRCUIT_BREAKER_FAILURE_THRESHOLD=5
S3_CIRCUIT_BREAKER_SUCCESS_THRESHOLD=3
S3_CIRCUIT_BREAKER_TIMEOUT_SECS=30
S3_CIRCUIT_BREAKER_FAILURE_WINDOW_SECS=60

INFERENCE_CIRCUIT_BREAKER_FAILURE_THRESHOLD=5
INFERENCE_CIRCUIT_BREAKER_SUCCESS_THRESHOLD=3
INFERENCE_CIRCUIT_BREAKER_TIMEOUT_SECS=30
INFERENCE_CIRCUIT_BREAKER_FAILURE_WINDOW_SECS=60

# ================================
# Retry Policy Configuration
# ================================
RETRY_MAX_ATTEMPTS=3
RETRY_INITIAL_DELAY_MS=100
RETRY_MAX_DELAY_MS=10000
RETRY_BACKOFF_MULTIPLIER=2.0
QDRANT_RETRY_MAX_ATTEMPTS=3
S3_RETRY_MAX_ATTEMPTS=3
INFERENCE_RETRY_MAX_ATTEMPTS=3

# ================================
# Observability & Monitoring
# ================================
OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4317
LOG_FORMAT=json
RUST_LOG=worker_datasets=debug
